---
layout:     post
title:      热门博客排行以及缓存提速
subtitle:   
date:       2018-03-07
author:     YH
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
  - Django
  - 笔记
  - 博客
---

## 21.热门博客排行以及缓存提速


Github链接地址：[Github地址](https://github.com/yhxt/django2.0-code/tree/master/21.%E7%83%AD%E9%97%A8%E5%8D%9A%E5%AE%A2%E6%8E%92%E8%A1%8C%E4%BB%A5%E5%8F%8A%E7%BC%93%E5%AD%98%E6%8F%90%E9%80%9F)

[TOC]

### 一、利用阅读数量排行

#### 1.24小时内

>  read_statistics/utils.py

- 首先在read_statistics/utils.py文件里新建今天阅读数量QuerySet的方法：**get_today_hot_data()**,按照阅读量从多到少排序，取出数量最多的前7条数据

![image.png](http://upload-images.jianshu.io/upload_images/545178-2682d7a512fe0477.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)




read_statistics/utils.py
```python
def get_today_hot_data(content_type):
    '''获取今天24小时阅读数量-按照阅读量从多到少排序'''
    today = timezone.now().date() #当天的时间
    read_details = ReadDetail.objects.filter(content_type=content_type,date=today).order_by('-read_num')[:7]
    return read_details
```

- 然后在yhsite/views.py里面引用get_today_hot_data方法并且返回数据给前台home.html页面

![image.png](http://upload-images.jianshu.io/upload_images/545178-e6ca5bb8553e677e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


yhsite/views.py
```python
from django.shortcuts import render
from django.contrib.contenttypes.models import ContentType
from read_statistics.utils import get_seven_days_read_data,get_today_hot_data
from blog.models import Blog

def home(request):
    blog_content_type=ContentType.objects.get_for_model(Blog)       #获取文件类型
    dates,read_nums=get_seven_days_read_data(blog_content_type)     #获取该文件类型下前7天的阅读数
    today_hot_data = get_today_hot_data(blog_content_type)          #获取今天阅读数

    return render(request,'home.html',{'dates':dates,'read_nums':read_nums,'today_hot_data':today_hot_data})
```
- 接下来打开templates/home.html文件,在里面添加相关html文件用于页面展示以及获取数据

![image.png](http://upload-images.jianshu.io/upload_images/545178-e4bffccbff8fd2d5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


> **注意：** 1.上述的object_id和content_object字段均来自read_statistics/models.py里面ReadDetail模型里面的字段
> 2.object_id是获取文章的id;content_object是获取文章的对象
> **（如果文章模型blog在其模型里面使用了__str__方法返回标题，content_object即可以直接获取的是文章的标题）**

页面显示效果：
![image.png](http://upload-images.jianshu.io/upload_images/545178-0cff8fe7ae17c062.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


#### 2.昨天

>  read_statistics/utils.py

- 类似于今天的热点阅读，唯一不同就是查询的date数据是昨天时间即可。
- 在read_statistics/utils.py文件里新建今天阅读数量QuerySet的方法：**get_yesterday_hot_data()**,按照阅读量从多到少排序，取出数量最多的前7条数据

![image.png](http://upload-images.jianshu.io/upload_images/545178-16f15a0d58543d18.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


read_statistics/utils.py
```python
def get_yesterday_hot_data(content_type):
    '''获取今天24小时阅读数量-按照阅读量从多到少排序,取前7条数据'''
    today = timezone.now().date()         #当天的时间
    yesterday=today-datetime.timedelta(days=1) #昨天的时间
    read_details = ReadDetail.objects.filter(content_type=content_type,date=yesterday).order_by('-read_num')[:7]
    return read_details
```

- 然后在yhsite/views.py里面引用get_yesterday_hot_data方法并且返回数据给前台home.html页面

![image.png](http://upload-images.jianshu.io/upload_images/545178-4570432a03709fe4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



yhsite/views.py
```python
from django.shortcuts import render
from django.contrib.contenttypes.models import ContentType
from read_statistics.utils import get_seven_days_read_data,get_today_hot_data,get_yesterday_hot_data
from blog.models import Blog

def home(request):
    blog_content_type=ContentType.objects.get_for_model(Blog)       # 获取文件类型
    dates,read_nums=get_seven_days_read_data(blog_content_type)     # 获取该文件类型下前7天的阅读数
    today_hot_data = get_today_hot_data(blog_content_type)          # 获取今日24小时热门阅读点击
    yesterday_hot_data = get_yesterday_hot_data(blog_content_type)  # 获取昨天热门阅读点击

    return render(request,'home.html',{'dates':dates,'read_nums':read_nums,
                                                'today_hot_data':today_hot_data,
                                                'yesterday_hot_data':yesterday_hot_data})
```
- 接下来打开templates/home.html文件,在里面添加相关html文件用于页面展示以及获取数据

![image.png](http://upload-images.jianshu.io/upload_images/545178-a658dccf44fabadd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


页面显示效果：
![image.png](http://upload-images.jianshu.io/upload_images/545178-a04ad9ffbcc11736.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
