---
layout:     post
title:      博客阅读数的统计(一)
subtitle:   
date:       2018-03-04
author:     YH
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
  - Django
  - 笔记
  - 博客
---


[TOC]

### 1.粗略统计
博客阅读数的统计根据业务的精细度可以多种方法实现，其中最简单的方式就是在models.py定义readed_num字段，然后在打开文章详情页时候给阅读数字段+1即可（此方法计算不准确，刷新页面也会使得阅读数增加，在粗略计算下可以使用）
![blog/models.py](http://upload-images.jianshu.io/upload_images/545178-2572ad6b5a34748b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

![blog/views.py](http://upload-images.jianshu.io/upload_images/545178-ce8fbb1a4f9e63c5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


###2.使用cookie统计
设置cookie，并获取cookie来判断该篇文章是否阅读过
根据设置访问文章的cookie的键key和值value来标记文章是否被阅读过，如果阅读过设置cookie,在打开文章时候先获取cookie来判断是否存在，如果不存在，阅读数+1；cookie存在则阅读数保持不变
>**存在问题**：
 1.每次阅读数改变的时候，admin管理后台的更新时间会跟着变化
 2.当管理员在编辑某篇文章，此时有人点击该篇文章，阅读数增加，但是管理员编辑修改完文章保存后，阅读数会是管理员编辑文章时候的阅读数量
 
![blog/models.py](http://upload-images.jianshu.io/upload_images/545178-7e5c4e72b22ace76.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

![blog/views.py](http://upload-images.jianshu.io/upload_images/545178-ced94ab7ec32043e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

```python
def blog_detail(request,blog_pk):
    """博客详情页"""
    blog=get_object_or_404(Blog,pk=blog_pk) # 根据传入blog_pk的ID来找到具体对应博客文章

    # 获取cookie：根据获取cookie的key值'blog_%s_readed' % blog_pk，判断是否存在，不存在则阅读数+1
    if not request.COOKIES.get('blog_%s_readed' % blog_pk):
        blog.readed_num += 1    #点击该篇文章，阅读数自增1
        blog.save()

    pre_blog=Blog.objects.filter(id__gt=blog.id).last() # 博客的上一篇文章
    next_blog=Blog.objects.filter(id__lt=blog.id).first()   # 博客的下一篇文章
    response=render(request,'blog/blog_detail.html',{'blog':blog,'pre_blog':pre_blog,'next_blog':next_blog})    #响应
    
    # 设置cookie,打开过这篇文章即写入cookie,key是'blog_%s_readed' % blog_pk,value是'true'
    response.set_cookie('blog_%s_readed' % blog_pk,'true')
    return response
```
